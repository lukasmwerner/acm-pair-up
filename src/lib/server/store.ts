import type { AvoidanceHistoryEntry, Event, EventSummary, ID, Pairing, Participant, Presence, Round } from './types';

function now() { return Date.now(); }
function randomId(prefix = ''): ID { return prefix + Math.random().toString(36).slice(2, 10); }
function randomToken(): string { return crypto.getRandomValues(new Uint32Array(4)).join('-'); }

export const db = {
	events: new Map<ID, Event>(),
	participants: new Map<ID, Participant>(),
	presence: new Map<ID, Presence>(), // key: participantId
	rounds: new Map<ID, Round>(),
	pairings: new Map<ID, Pairing>(),
	eventRounds: new Map<ID, ID[]>(), // eventId -> roundIds
	roundPairs: new Map<ID, ID[]>(), // roundId -> pairingIds
	avoidance: new Map<string, AvoidanceHistoryEntry>(), // `${eventId}:${p1}:${p2}` sorted ids
};

export function createEvent(name: string, code: string): Event {
	const id = randomId('evt_');
	const adminKey = randomId('adm_');
	const event: Event = {
		id,
		name,
		code,
		status: 'open',
		settings: { avoidRepeatWindow: 3, oddHandling: 'waiting', hexLength: 2 },
		createdAt: now(),
		adminKey,
	};
	db.events.set(id, event);
	db.eventRounds.set(id, []);
	return event;
}

const EMOJIS = [
	{ emoji: 'ðŸ¶', name: 'Dog' },
	{ emoji: 'ðŸ±', name: 'Cat' },
	{ emoji: 'ðŸ­', name: 'Mouse' },
	{ emoji: 'ðŸ¹', name: 'Hamster' },
	{ emoji: 'ðŸ°', name: 'Rabbit' },
	{ emoji: 'ðŸ¦Š', name: 'Fox' },
	{ emoji: 'ðŸ»', name: 'Bear' },
	{ emoji: 'ðŸ¼', name: 'Panda' },
	{ emoji: 'ðŸ¨', name: 'Koala' },
	{ emoji: 'ðŸ¯', name: 'Tiger' },
	{ emoji: 'ðŸ¦', name: 'Lion' },
	{ emoji: 'ðŸ®', name: 'Cow' },
	{ emoji: 'ðŸ·', name: 'Pig' },
	{ emoji: 'ðŸ¸', name: 'Frog' },
	{ emoji: 'ðŸµ', name: 'Monkey' },
	{ emoji: 'ðŸ”', name: 'Chicken' },
	{ emoji: 'ðŸ§', name: 'Penguin' },
	{ emoji: 'ðŸ¦', name: 'Bird' },
	{ emoji: 'ðŸ¤', name: 'Chick' },
	{ emoji: 'ðŸ¦†', name: 'Duck' },
	{ emoji: 'ðŸ¦…', name: 'Eagle' },
	{ emoji: 'ðŸ¦‰', name: 'Owl' },
	{ emoji: 'ðŸ¦‡', name: 'Bat' },
	{ emoji: 'ðŸº', name: 'Wolf' },
	{ emoji: 'ðŸ—', name: 'Boar' },
	{ emoji: 'ðŸ´', name: 'Horse' },
	{ emoji: 'ðŸ¦„', name: 'Unicorn' },
	{ emoji: 'ðŸ', name: 'Bee' },
	{ emoji: 'ðŸ›', name: 'Bug' },
	{ emoji: 'ðŸ¦‹', name: 'Butterfly' },
	{ emoji: 'ðŸŒ', name: 'Snail' },
	{ emoji: 'ðŸž', name: 'Ladybug' },
	{ emoji: 'ðŸ¢', name: 'Turtle' },
	{ emoji: 'ðŸ', name: 'Snake' },
	{ emoji: 'ðŸ¦Ž', name: 'Lizard' },
	{ emoji: 'ðŸ¦–', name: 'T-Rex' },
	{ emoji: 'ðŸ¦•', name: 'Dinosaur' },
	{ emoji: 'ðŸ™', name: 'Octopus' },
	{ emoji: 'ðŸ¦‘', name: 'Squid' },
	{ emoji: 'ðŸ¦', name: 'Shrimp' },
	{ emoji: 'ðŸ¦ž', name: 'Lobster' },
	{ emoji: 'ðŸ¦€', name: 'Crab' },
	{ emoji: 'ðŸ¡', name: 'Blowfish' },
	{ emoji: 'ðŸ ', name: 'Fish' },
	{ emoji: 'ðŸŸ', name: 'Goldfish' },
	{ emoji: 'ðŸ¬', name: 'Dolphin' },
	{ emoji: 'ðŸ³', name: 'Whale' },
	{ emoji: 'ðŸ‹', name: 'Blue Whale' },
	{ emoji: 'ðŸ¦ˆ', name: 'Shark' },
	{ emoji: 'ðŸŠ', name: 'Crocodile' },
	{ emoji: 'ðŸ…', name: 'Tiger Face' },
	{ emoji: 'ðŸ†', name: 'Leopard' },
	{ emoji: 'ðŸ¦“', name: 'Zebra' },
	{ emoji: 'ðŸ¦', name: 'Gorilla' },
	{ emoji: 'ðŸ¦§', name: 'Orangutan' },
	{ emoji: 'ðŸ˜', name: 'Elephant' },
	{ emoji: 'ðŸ¦›', name: 'Hippo' },
	{ emoji: 'ðŸ¦', name: 'Rhino' },
	{ emoji: 'ðŸª', name: 'Camel' },
	{ emoji: 'ðŸ«', name: 'Two-Hump Camel' },
	{ emoji: 'ðŸ¦’', name: 'Giraffe' },
	{ emoji: 'ðŸ¦˜', name: 'Kangaroo' },
	{ emoji: 'ðŸ¦¬', name: 'Bison' },
	{ emoji: 'ðŸƒ', name: 'Water Buffalo' },
	{ emoji: 'ðŸ‚', name: 'Ox' },
	{ emoji: 'ðŸ„', name: 'Milk Cow' },
	{ emoji: 'ðŸŽ', name: 'Racing Horse' },
	{ emoji: 'ðŸ–', name: 'Pig Face' },
	{ emoji: 'ðŸ', name: 'Ram' },
	{ emoji: 'ðŸ‘', name: 'Sheep' },
	{ emoji: 'ðŸ¦™', name: 'Llama' },
	{ emoji: 'ðŸ', name: 'Goat' },
	{ emoji: 'ðŸ¦Œ', name: 'Deer' },
	{ emoji: 'ðŸ•', name: 'Dog Face' },
	{ emoji: 'ðŸ©', name: 'Poodle' },
	{ emoji: 'ðŸ¦®', name: 'Guide Dog' },
	{ emoji: 'ðŸ•â€ðŸ¦º', name: 'Service Dog' },
	{ emoji: 'ðŸˆ', name: 'Cat Face' },
	{ emoji: 'ðŸˆâ€â¬›', name: 'Black Cat' },
	{ emoji: 'ðŸ¦š', name: 'Peacock' },
	{ emoji: 'ðŸ¦œ', name: 'Parrot' },
	{ emoji: 'ðŸ¦¢', name: 'Swan' },
	{ emoji: 'ðŸ¦©', name: 'Flamingo' },
	{ emoji: 'ðŸ•Š', name: 'Dove' },
	{ emoji: 'ðŸ‡', name: 'Rabbit Face' },
	{ emoji: 'ðŸ¦', name: 'Raccoon' },
	{ emoji: 'ðŸ¦¨', name: 'Skunk' },
	{ emoji: 'ðŸ¦¡', name: 'Badger' },
	{ emoji: 'ðŸ¦¦', name: 'Otter' },
	{ emoji: 'ðŸ¦¥', name: 'Sloth' },
	{ emoji: 'ðŸ', name: 'Mouse Face' },
	{ emoji: 'ðŸ€', name: 'Rat' },
	{ emoji: 'ðŸ¿', name: 'Chipmunk' },
	{ emoji: 'ðŸ¦”', name: 'Hedgehog' },
	{ emoji: 'ðŸŒµ', name: 'Cactus' },
	{ emoji: 'ðŸŒ²', name: 'Pine Tree' },
	{ emoji: 'ðŸŒ³', name: 'Tree' },
	{ emoji: 'ðŸŒ´', name: 'Palm Tree' },
	{ emoji: 'ðŸŒ±', name: 'Seedling' },
	{ emoji: 'ðŸŒ¿', name: 'Herb' },
	{ emoji: 'â˜˜', name: 'Shamrock' },
	{ emoji: 'ðŸ€', name: 'Four Leaf Clover' },
	{ emoji: 'ðŸŒ¾', name: 'Rice' },
	{ emoji: 'ðŸŒº', name: 'Hibiscus' },
	{ emoji: 'ðŸŒ»', name: 'Sunflower' },
	{ emoji: 'ðŸŒ¹', name: 'Rose' },
	{ emoji: 'ðŸŒ·', name: 'Tulip' },
	{ emoji: 'ðŸŒ¸', name: 'Cherry Blossom' },
	{ emoji: 'ðŸ’', name: 'Bouquet' },
	{ emoji: 'ðŸ„', name: 'Mushroom' },
	{ emoji: 'ðŸŒ°', name: 'Chestnut' },
	{ emoji: 'â­', name: 'Star' },
	{ emoji: 'âœ¨', name: 'Sparkles' },
	{ emoji: 'âš¡', name: 'Lightning' },
	{ emoji: 'â˜€', name: 'Sun' },
	{ emoji: 'ðŸŒ™', name: 'Moon' },
	{ emoji: 'ðŸŒˆ', name: 'Rainbow' },
	{ emoji: 'â˜', name: 'Cloud' },
	{ emoji: 'â›…', name: 'Partly Cloudy' },
	{ emoji: 'â›ˆ', name: 'Storm' },
	{ emoji: 'ðŸŒŠ', name: 'Wave' },
	{ emoji: 'ðŸ’§', name: 'Droplet' },
	{ emoji: 'ðŸ”¥', name: 'Fire' },
	{ emoji: 'â„', name: 'Snowflake' },
	{ emoji: 'ðŸŽ', name: 'Apple' },
	{ emoji: 'ðŸŠ', name: 'Orange' },
	{ emoji: 'ðŸ‹', name: 'Lemon' },
	{ emoji: 'ðŸŒ', name: 'Banana' },
	{ emoji: 'ðŸ‰', name: 'Watermelon' },
	{ emoji: 'ðŸ‡', name: 'Grapes' },
	{ emoji: 'ðŸ“', name: 'Strawberry' },
	{ emoji: 'ðŸ’', name: 'Cherry' },
	{ emoji: 'ðŸ‘', name: 'Peach' },
	{ emoji: 'ðŸ¥­', name: 'Mango' },
	{ emoji: 'ðŸ', name: 'Pineapple' },
	{ emoji: 'ðŸ¥¥', name: 'Coconut' },
	{ emoji: 'ðŸ¥', name: 'Kiwi' },
	{ emoji: 'ðŸ…', name: 'Tomato' },
	{ emoji: 'ðŸ¥‘', name: 'Avocado' },
	{ emoji: 'ðŸŒ½', name: 'Corn' },
	{ emoji: 'ðŸŒ¶', name: 'Pepper' },
	{ emoji: 'ðŸ¥’', name: 'Cucumber' },
	{ emoji: 'ðŸ¥•', name: 'Carrot' },
	{ emoji: 'ðŸ¥¦', name: 'Broccoli' },
	{ emoji: 'ðŸ§„', name: 'Garlic' },
	{ emoji: 'ðŸ§…', name: 'Onion' },
	{ emoji: 'ðŸž', name: 'Bread' },
	{ emoji: 'ðŸ¥', name: 'Croissant' },
	{ emoji: 'ðŸ¥–', name: 'Baguette' },
	{ emoji: 'ðŸ¥¨', name: 'Pretzel' },
	{ emoji: 'ðŸ§€', name: 'Cheese' },
	{ emoji: 'ðŸ•', name: 'Pizza' },
	{ emoji: 'ðŸ”', name: 'Burger' },
	{ emoji: 'ðŸŒ­', name: 'Hot Dog' },
	{ emoji: 'ðŸ¥ª', name: 'Sandwich' },
	{ emoji: 'ðŸŒ®', name: 'Taco' },
	{ emoji: 'ðŸŒ¯', name: 'Burrito' },
	{ emoji: 'ðŸ¥™', name: 'Pita' },
	{ emoji: 'ðŸ¿', name: 'Popcorn' },
	{ emoji: 'ðŸ¦', name: 'Ice Cream' },
	{ emoji: 'ðŸ©', name: 'Donut' },
	{ emoji: 'ðŸª', name: 'Cookie' },
	{ emoji: 'ðŸŽ‚', name: 'Cake' },
	{ emoji: 'ðŸ§', name: 'Cupcake' },
	{ emoji: 'ðŸ°', name: 'Shortcake' },
	{ emoji: 'ðŸ¥§', name: 'Pie' },
	{ emoji: 'ðŸ«', name: 'Chocolate' },
	{ emoji: 'ðŸ¬', name: 'Candy' },
	{ emoji: 'ðŸ­', name: 'Lollipop' },
	{ emoji: 'ðŸ®', name: 'Pudding' },
	{ emoji: 'ðŸ¯', name: 'Honey' },
	{ emoji: 'âš½', name: 'Soccer Ball' },
	{ emoji: 'ðŸ€', name: 'Basketball' },
	{ emoji: 'ðŸˆ', name: 'Football' },
	{ emoji: 'âš¾', name: 'Baseball' },
	{ emoji: 'ðŸŽ¾', name: 'Tennis' },
	{ emoji: 'ðŸ', name: 'Volleyball' },
	{ emoji: 'ðŸ‰', name: 'Rugby' },
	{ emoji: 'ðŸŽ±', name: '8-Ball' },
	{ emoji: 'ðŸ“', name: 'Ping Pong' },
	{ emoji: 'ðŸ¸', name: 'Badminton' },
	{ emoji: 'ðŸ¥Š', name: 'Boxing Glove' },
	{ emoji: 'ðŸŽ¯', name: 'Dart' },
	{ emoji: 'ðŸŽ®', name: 'Game Controller' },
	{ emoji: 'ðŸŽ²', name: 'Dice' },
	{ emoji: 'ðŸŽ¨', name: 'Palette' },
	{ emoji: 'ðŸŽ­', name: 'Theater' },
	{ emoji: 'ðŸŽª', name: 'Circus' },
	{ emoji: 'ðŸŽ¸', name: 'Guitar' },
	{ emoji: 'ðŸŽ¹', name: 'Piano' },
	{ emoji: 'ðŸŽº', name: 'Trumpet' },
	{ emoji: 'ðŸŽ»', name: 'Violin' },
	{ emoji: 'ðŸ¥', name: 'Drum' },
	{ emoji: 'ðŸŽ¤', name: 'Microphone' },
	{ emoji: 'ðŸŽ§', name: 'Headphones' },
	{ emoji: 'ðŸ“»', name: 'Radio' },
	{ emoji: 'ðŸŽ¬', name: 'Movie' },
	{ emoji: 'ðŸ“š', name: 'Books' },
	{ emoji: 'ðŸ“–', name: 'Book' },
	{ emoji: 'âœ', name: 'Pencil' },
	{ emoji: 'âœ’', name: 'Pen' },
	{ emoji: 'ðŸ–Š', name: 'Ballpoint Pen' },
	{ emoji: 'ðŸ–', name: 'Crayon' },
	{ emoji: 'ðŸ“', name: 'Memo' },
	{ emoji: 'ðŸ”', name: 'Magnifying Glass' },
	{ emoji: 'ðŸ”Ž', name: 'Magnifying Glass Right' },
	{ emoji: 'ðŸ”’', name: 'Lock' },
	{ emoji: 'ðŸ”“', name: 'Unlock' },
	{ emoji: 'ðŸ”‘', name: 'Key' },
	{ emoji: 'ðŸ”¨', name: 'Hammer' },
	{ emoji: 'ðŸª“', name: 'Axe' },
	{ emoji: 'â›', name: 'Pick' },
	{ emoji: 'ðŸ”§', name: 'Wrench' },
	{ emoji: 'ðŸ”©', name: 'Nut and Bolt' },
	{ emoji: 'âš™', name: 'Gear' },
	{ emoji: 'ðŸ§°', name: 'Toolbox' },
	{ emoji: 'ðŸ§²', name: 'Magnet' },
	{ emoji: 'ðŸªœ', name: 'Ladder' },
	{ emoji: 'ðŸ”¬', name: 'Microscope' },
	{ emoji: 'ðŸ”­', name: 'Telescope' },
	{ emoji: 'ðŸ©º', name: 'Stethoscope' },
	{ emoji: 'ðŸ’Š', name: 'Pill' },
	{ emoji: 'ðŸ©¹', name: 'Bandage' },
	{ emoji: 'ðŸŒ¡', name: 'Thermometer' },
	{ emoji: 'ðŸ§¬', name: 'DNA' },
	{ emoji: 'ðŸ”‹', name: 'Battery' },
	{ emoji: 'ðŸ’¡', name: 'Light Bulb' },
	{ emoji: 'ðŸ”¦', name: 'Flashlight' },
	{ emoji: 'ðŸ•¯', name: 'Candle' },
	{ emoji: 'ðŸ§¯', name: 'Fire Extinguisher' },
	{ emoji: 'ðŸŽˆ', name: 'Balloon' },
	{ emoji: 'ðŸŽ€', name: 'Ribbon' },
	{ emoji: 'ðŸŽ', name: 'Gift' },
	{ emoji: 'ðŸ†', name: 'Trophy' },
	{ emoji: 'ðŸ¥‡', name: 'Gold Medal' },
	{ emoji: 'ðŸ¥ˆ', name: 'Silver Medal' },
	{ emoji: 'ðŸ¥‰', name: 'Bronze Medal' },
	{ emoji: 'âš”', name: 'Swords' },
	{ emoji: 'ðŸ›¡', name: 'Shield' },
	{ emoji: 'ðŸ¹', name: 'Bow and Arrow' },
	{ emoji: 'ðŸªƒ', name: 'Boomerang' },
	{ emoji: 'ðŸŽ£', name: 'Fishing Pole' },
	{ emoji: 'ðŸ§©', name: 'Puzzle Piece' },
	{ emoji: 'ðŸŽ°', name: 'Slot Machine' },
	{ emoji: 'ðŸš€', name: 'Rocket' },
	{ emoji: 'ðŸ›¸', name: 'UFO' },
	{ emoji: 'ðŸ›°', name: 'Satellite' },
	{ emoji: 'ðŸŒŒ', name: 'Milky Way' },
	{ emoji: 'ðŸŒ ', name: 'Shooting Star' },
	{ emoji: 'â›º', name: 'Tent' },
	{ emoji: 'ðŸ•', name: 'Camping' },
	{ emoji: 'ðŸ—»', name: 'Mount Fuji' },
	{ emoji: 'ðŸ”', name: 'Mountain' },
	{ emoji: 'â›°', name: 'Mountain Peak' },
	{ emoji: 'ðŸ–', name: 'Beach' },
	{ emoji: 'ðŸ', name: 'Desert Island' },
	{ emoji: 'ðŸœ', name: 'Desert' },
	{ emoji: 'ðŸž', name: 'Park' },
	{ emoji: 'ðŸŸ', name: 'Stadium' },
	{ emoji: 'ðŸ›', name: 'Classical Building' },
	{ emoji: 'ðŸ—', name: 'Construction' },
	{ emoji: 'ðŸ§±', name: 'Brick' },
	{ emoji: 'ðŸ˜', name: 'Houses' },
	{ emoji: 'ðŸš', name: 'House' },
	{ emoji: 'ðŸ ', name: 'Home' },
	{ emoji: 'ðŸ¡', name: 'Garden' },
	{ emoji: 'ðŸ¢', name: 'Office Building' },
	{ emoji: 'ðŸ£', name: 'Post Office' },
	{ emoji: 'ðŸ¤', name: 'European Post Office' },
	{ emoji: 'ðŸ¥', name: 'Hospital' },
	{ emoji: 'ðŸ¦', name: 'Bank' },
	{ emoji: 'ðŸ¨', name: 'Hotel' },
	{ emoji: 'ðŸ©', name: 'Love Hotel' },
	{ emoji: 'ðŸª', name: 'Store' },
	{ emoji: 'ðŸ«', name: 'School' },
	{ emoji: 'ðŸ¬', name: 'Department Store' },
	{ emoji: 'ðŸ­', name: 'Factory' },
	{ emoji: 'ðŸ¯', name: 'Castle' },
	{ emoji: 'ðŸ°', name: 'European Castle' },
	{ emoji: 'ðŸ’’', name: 'Wedding' },
	{ emoji: 'ðŸ—¼', name: 'Tower' },
	{ emoji: 'ðŸ—½', name: 'Statue of Liberty' },
	{ emoji: 'â›ª', name: 'Church' },
	{ emoji: 'ðŸ•Œ', name: 'Mosque' },
	{ emoji: 'ðŸ›•', name: 'Temple' },
	{ emoji: 'ðŸ•', name: 'Synagogue' },
	{ emoji: 'â›©', name: 'Shrine' },
	{ emoji: 'ðŸ•‹', name: 'Kaaba' },
	{ emoji: 'â›²', name: 'Fountain' },
	{ emoji: 'â›±', name: 'Umbrella' },
	{ emoji: 'ðŸŒ', name: 'Foggy' },
	{ emoji: 'ðŸŒƒ', name: 'Night' },
	{ emoji: 'ðŸŒ„', name: 'Sunrise' },
	{ emoji: 'ðŸŒ…', name: 'Sunrise Over Mountains' },
	{ emoji: 'ðŸŒ†', name: 'Dusk' },
	{ emoji: 'ðŸŒ‡', name: 'Sunset' },
	{ emoji: 'ðŸŒ‰', name: 'Bridge at Night' },
	{ emoji: 'ðŸŽ¢', name: 'Roller Coaster' },
	{ emoji: 'ðŸŽ¡', name: 'Ferris Wheel' },
	{ emoji: 'ðŸŽ ', name: 'Carousel' },
	{ emoji: 'â›²', name: 'Fountain' },
	{ emoji: 'â›±', name: 'Umbrella on Ground' },
	{ emoji: 'ðŸš—', name: 'Car' },
	{ emoji: 'ðŸš•', name: 'Taxi' },
	{ emoji: 'ðŸš™', name: 'SUV' },
	{ emoji: 'ðŸšŒ', name: 'Bus' },
	{ emoji: 'ðŸšŽ', name: 'Trolleybus' },
	{ emoji: 'ðŸŽ', name: 'Race Car' },
	{ emoji: 'ðŸš“', name: 'Police Car' },
	{ emoji: 'ðŸš‘', name: 'Ambulance' },
	{ emoji: 'ðŸš’', name: 'Fire Truck' },
	{ emoji: 'ðŸš', name: 'Minibus' },
	{ emoji: 'ðŸšš', name: 'Delivery Truck' },
	{ emoji: 'ðŸš›', name: 'Truck' },
	{ emoji: 'ðŸšœ', name: 'Tractor' },
	{ emoji: 'ðŸ›´', name: 'Scooter' },
	{ emoji: 'ðŸš²', name: 'Bicycle' },
	{ emoji: 'ðŸ›µ', name: 'Motor Scooter' },
	{ emoji: 'ðŸ', name: 'Motorcycle' },
	{ emoji: 'ðŸ›º', name: 'Tuk Tuk' },
	{ emoji: 'ðŸš¨', name: 'Police Siren' },
	{ emoji: 'ðŸš”', name: 'Police Car Front' },
	{ emoji: 'ðŸš', name: 'Bus Front' },
	{ emoji: 'ðŸš˜', name: 'Car Front' },
	{ emoji: 'ðŸš–', name: 'Taxi Front' },
	{ emoji: 'ðŸš¡', name: 'Aerial Tramway' },
	{ emoji: 'ðŸš ', name: 'Mountain Cableway' },
	{ emoji: 'ðŸšŸ', name: 'Suspension Railway' },
	{ emoji: 'ðŸšƒ', name: 'Railway Car' },
	{ emoji: 'ðŸš‹', name: 'Tram' },
	{ emoji: 'ðŸšž', name: 'Mountain Railway' },
	{ emoji: 'ðŸš', name: 'Monorail' },
	{ emoji: 'ðŸš„', name: 'High-Speed Train' },
	{ emoji: 'ðŸš…', name: 'Bullet Train' },
	{ emoji: 'ðŸšˆ', name: 'Light Rail' },
	{ emoji: 'ðŸš‚', name: 'Locomotive' },
	{ emoji: 'ðŸš†', name: 'Train' },
	{ emoji: 'ðŸš‡', name: 'Metro' },
	{ emoji: 'ðŸšŠ', name: 'Tram Car' },
	{ emoji: 'ðŸš‰', name: 'Station' },
	{ emoji: 'âœˆ', name: 'Airplane' },
	{ emoji: 'ðŸ›«', name: 'Takeoff' },
	{ emoji: 'ðŸ›¬', name: 'Landing' },
	{ emoji: 'ðŸª‚', name: 'Parachute' },
	{ emoji: 'ðŸ’º', name: 'Seat' },
	{ emoji: 'ðŸš', name: 'Helicopter' },
	{ emoji: 'ðŸ›©', name: 'Small Airplane' },
	{ emoji: 'ðŸ›¶', name: 'Canoe' },
	{ emoji: 'â›µ', name: 'Sailboat' },
	{ emoji: 'ðŸš¤', name: 'Speedboat' },
	{ emoji: 'ðŸ›¥', name: 'Motorboat' },
	{ emoji: 'ðŸ›³', name: 'Cruise Ship' },
	{ emoji: 'â›´', name: 'Ferry' },
	{ emoji: 'ðŸš¢', name: 'Ship' },
	{ emoji: 'âš“', name: 'Anchor' },
	{ emoji: 'ðŸª', name: 'Hook' },
	{ emoji: 'â›½', name: 'Gas Pump' },
	{ emoji: 'ðŸš§', name: 'Construction Sign' },
	{ emoji: 'ðŸš¦', name: 'Traffic Light' },
	{ emoji: 'ðŸš¥', name: 'Traffic Light Horizontal' },
	{ emoji: 'ðŸ', name: 'Checkered Flag' },
	{ emoji: 'ðŸŽŒ', name: 'Crossed Flags' },
	{ emoji: 'ðŸ´', name: 'Black Flag' },
	{ emoji: 'ðŸ³', name: 'White Flag' },
	{ emoji: 'ðŸ³ï¸â€ðŸŒˆ', name: 'Rainbow Flag' },
	{ emoji: 'ðŸ´â€â˜ ï¸', name: 'Pirate Flag' },
	{ emoji: 'ðŸ§­', name: 'Compass' },
	{ emoji: 'ðŸ—¿', name: 'Moai' },
	{ emoji: 'ðŸ—¾', name: 'Japan Map' },
	{ emoji: 'ðŸ—º', name: 'World Map' },
	{ emoji: 'ðŸ§³', name: 'Luggage' },
	{ emoji: 'âŒ›', name: 'Hourglass Done' },
	{ emoji: 'â³', name: 'Hourglass Not Done' },
	{ emoji: 'âŒš', name: 'Watch' },
	{ emoji: 'â°', name: 'Alarm Clock' },
	{ emoji: 'â±', name: 'Stopwatch' },
	{ emoji: 'â²', name: 'Timer' },
	{ emoji: 'ðŸ•°', name: 'Mantelpiece Clock' },
	{ emoji: 'ðŸŒ€', name: 'Cyclone' },
	{ emoji: 'â™ ', name: 'Spade' },
	{ emoji: 'â™¥', name: 'Heart Suit' },
	{ emoji: 'â™¦', name: 'Diamond' },
	{ emoji: 'â™£', name: 'Club' },
	{ emoji: 'ðŸƒ', name: 'Joker' },
	{ emoji: 'ðŸ€„', name: 'Mahjong' },
	{ emoji: 'ðŸŽ´', name: 'Flower Cards' },
	{ emoji: 'ðŸ”®', name: 'Crystal Ball' },
	{ emoji: 'ðŸª¬', name: 'Hamsa' },
	{ emoji: 'ðŸ§¿', name: 'Nazar' },
	{ emoji: 'ðŸª†', name: 'Nesting Dolls' },
	{ emoji: 'ðŸŽŠ', name: 'Confetti Ball' },
	{ emoji: 'ðŸŽ‰', name: 'Party Popper' },
	{ emoji: 'ðŸŽŽ', name: 'Dolls' },
	{ emoji: 'ðŸ®', name: 'Lantern' },
	{ emoji: 'ðŸŽ', name: 'Wind Chime' },
	{ emoji: 'ðŸ§§', name: 'Red Envelope' },
	{ emoji: 'âœ‰', name: 'Envelope' },
	{ emoji: 'ðŸ“©', name: 'Envelope with Arrow' },
	{ emoji: 'ðŸ“¨', name: 'Incoming Envelope' },
	{ emoji: 'ðŸ“§', name: 'E-Mail' },
	{ emoji: 'ðŸ’Œ', name: 'Love Letter' },
	{ emoji: 'ðŸ“¥', name: 'Inbox' },
	{ emoji: 'ðŸ“¤', name: 'Outbox' },
	{ emoji: 'ðŸ“¦', name: 'Package' },
	{ emoji: 'ðŸ·', name: 'Label' },
	{ emoji: 'ðŸª§', name: 'Placard' },
	{ emoji: 'ðŸ“ª', name: 'Closed Mailbox' },
	{ emoji: 'ðŸ“«', name: 'Mailbox with Flag' },
	{ emoji: 'ðŸ“¬', name: 'Open Mailbox' },
	{ emoji: 'ðŸ“­', name: 'Open Mailbox No Flag' },
	{ emoji: 'ðŸ“®', name: 'Postbox' },
	{ emoji: 'ðŸ“¯', name: 'Postal Horn' },
	{ emoji: 'ðŸ“œ', name: 'Scroll' },
	{ emoji: 'ðŸ“ƒ', name: 'Page with Curl' },
	{ emoji: 'ðŸ“„', name: 'Page' },
	{ emoji: 'ðŸ“‘', name: 'Bookmark Tabs' },
	{ emoji: 'ðŸ”–', name: 'Bookmark' },
	{ emoji: 'ðŸ·', name: 'Label Tag' },
	{ emoji: 'ðŸ’°', name: 'Money Bag' },
	{ emoji: 'ðŸª™', name: 'Coin' },
	{ emoji: 'ðŸ’´', name: 'Yen' },
	{ emoji: 'ðŸ’µ', name: 'Dollar' },
	{ emoji: 'ðŸ’¶', name: 'Euro' },
	{ emoji: 'ðŸ’·', name: 'Pound' },
	{ emoji: 'ðŸ’¸', name: 'Money with Wings' },
	{ emoji: 'ðŸ’³', name: 'Credit Card' },
	{ emoji: 'ðŸ§¾', name: 'Receipt' },
	{ emoji: 'ðŸ’Ž', name: 'Gem' },
	{ emoji: 'âš–', name: 'Scales' },
	{ emoji: 'ðŸªœ', name: 'Ladder' },
	{ emoji: 'ðŸ§°', name: 'Toolbox' },
	{ emoji: 'ðŸª›', name: 'Screwdriver' },
	{ emoji: 'ðŸªš', name: 'Saw' },
	{ emoji: 'ðŸ”ª', name: 'Knife' },
	{ emoji: 'ðŸ—¡', name: 'Dagger' },
	{ emoji: 'âš”', name: 'Crossed Swords' },
	{ emoji: 'ðŸ”«', name: 'Water Gun' },
	{ emoji: 'ðŸªƒ', name: 'Boomerang' },
	{ emoji: 'ðŸ¹', name: 'Bow' },
	{ emoji: 'ðŸ›¡', name: 'Shield' },
	{ emoji: 'ðŸªš', name: 'Carpentry Saw' },
	{ emoji: 'ðŸ”§', name: 'Wrench' },
	{ emoji: 'ðŸª›', name: 'Screwdriver' },
	{ emoji: 'ðŸ”©', name: 'Bolt' },
	{ emoji: 'âš™', name: 'Gear' },
	{ emoji: 'ðŸ—œ', name: 'Clamp' },
	{ emoji: 'âš›', name: 'Atom' },
	{ emoji: 'ðŸ”¬', name: 'Microscope' },
	{ emoji: 'ðŸ”­', name: 'Telescope' },
	{ emoji: 'ðŸ“¡', name: 'Satellite Antenna' },
	{ emoji: 'ðŸ’‰', name: 'Syringe' },
	{ emoji: 'ðŸ©¸', name: 'Blood' },
	{ emoji: 'ðŸ’Š', name: 'Pill' },
	{ emoji: 'ðŸ©¹', name: 'Adhesive Bandage' },
	{ emoji: 'ðŸ©¼', name: 'Crutch' },
	{ emoji: 'ðŸ©º', name: 'Stethoscope' },
	{ emoji: 'ðŸ©»', name: 'X-Ray' },
	{ emoji: 'ðŸšª', name: 'Door' },
	{ emoji: 'ðŸ›—', name: 'Elevator' },
	{ emoji: 'ðŸªž', name: 'Mirror' },
	{ emoji: 'ðŸªŸ', name: 'Window' },
	{ emoji: 'ðŸ›', name: 'Bed' },
	{ emoji: 'ðŸ›‹', name: 'Couch' },
	{ emoji: 'ðŸª‘', name: 'Chair' },
	{ emoji: 'ðŸš½', name: 'Toilet' },
	{ emoji: 'ðŸª ', name: 'Plunger' },
	{ emoji: 'ðŸš¿', name: 'Shower' },
	{ emoji: 'ðŸ›', name: 'Bathtub' },
	{ emoji: 'ðŸª¤', name: 'Mouse Trap' },
	{ emoji: 'ðŸª’', name: 'Razor' },
	{ emoji: 'ðŸ§´', name: 'Lotion Bottle' },
	{ emoji: 'ðŸ§·', name: 'Safety Pin' },
	{ emoji: 'ðŸ§¹', name: 'Broom' },
	{ emoji: 'ðŸ§º', name: 'Basket' },
	{ emoji: 'ðŸ§»', name: 'Toilet Paper' },
	{ emoji: 'ðŸª£', name: 'Bucket' },
	{ emoji: 'ðŸ§¼', name: 'Soap' },
	{ emoji: 'ðŸ«§', name: 'Bubbles' },
	{ emoji: 'ðŸª¥', name: 'Toothbrush' },
	{ emoji: 'ðŸ§½', name: 'Sponge' },
	{ emoji: 'ðŸ§¯', name: 'Fire Extinguisher' },
	{ emoji: 'ðŸ›’', name: 'Shopping Cart' },
	{ emoji: 'ðŸš¬', name: 'Cigarette' },
	{ emoji: 'âš°', name: 'Coffin' },
	{ emoji: 'ðŸª¦', name: 'Tombstone' },
	{ emoji: 'âš±', name: 'Urn' },
	{ emoji: 'ðŸª§', name: 'Sign' },
	{ emoji: 'ðŸªª', name: 'ID Card' },
	{ emoji: 'ðŸ˜€', name: 'Grinning Face' },
	{ emoji: 'ðŸ˜‚', name: 'Face with Tears of Joy' },
	{ emoji: 'ðŸ™ƒ', name: 'Upside-Down Face' },
	{ emoji: 'ðŸ« ', name: 'Melting Face' },
	{ emoji: 'ðŸ˜‰', name: 'Winking Face' },
	{ emoji: 'ðŸ˜Š', name: 'Smiling Face with Smiling Eyes' },
	{ emoji: 'ðŸ˜‡', name: 'Smiling Face with Halo' },
	{ emoji: 'ðŸ¥°', name: 'Smiling Face with Hearts' },
	{ emoji: 'ðŸ˜', name: 'Smiling Face with Heart-Eyes' },
	{ emoji: 'ðŸ¤©', name: 'Star-Struck' },
	{ emoji: 'ðŸ˜˜', name: 'Face Blowing a Kiss' },
	{ emoji: 'ðŸ¥²', name: 'Smiling Face with Tear' },
	{ emoji: 'ðŸ˜‹', name: 'Face Savoring Food' },
	{ emoji: 'ðŸ˜›', name: 'Face with Tongue' },
	{ emoji: 'ðŸ¤ª', name: 'Zany Face' },
	{ emoji: 'ðŸ¤‘', name: 'Money-Mouth Face' },
	{ emoji: 'ðŸ¤—', name: 'Smiling Face with Open Hands' },
	{ emoji: 'ðŸ¤­', name: 'Face with Hand Over Mouth' },
	{ emoji: 'ðŸ«£', name: 'Face with Peeking Eye' },
	{ emoji: 'ðŸ¤«', name: 'Shushing Face' },
	{ emoji: 'ðŸ¤”', name: 'Thinking Face' },
	{ emoji: 'ðŸ«¡', name: 'Saluting Face' },
	{ emoji: 'ðŸ¤', name: 'Zipper-Mouth Face' },
	{ emoji: 'ðŸ¤¨', name: 'Face with Raised Eyebrow' },
	{ emoji: 'ðŸ˜', name: 'Neutral Face' },
	{ emoji: 'ðŸ˜¶', name: 'Face Without Mouth' },
	{ emoji: 'ðŸ«¥', name: 'Dotted Line Face' },
	{ emoji: 'ðŸ˜', name: 'Smirking Face' },
	{ emoji: 'ðŸ˜’', name: 'Unamused Face' },
	{ emoji: 'ðŸ™„', name: 'Face with Rolling Eyes' },
	{ emoji: 'ðŸ˜¬', name: 'Grimacing Face' },
	{ emoji: 'ðŸ˜®â€ðŸ’¨', name: 'Face Exhaling' },
	{ emoji: 'ðŸ¤¥', name: 'Lying Face' },
	{ emoji: 'ðŸ«¨', name: 'Shaking Face' },
	{ emoji: 'ðŸ˜Œ', name: 'Relieved Face' },
	{ emoji: 'ðŸ˜”', name: 'Pensive Face' },
	{ emoji: 'ðŸ˜´', name: 'Sleeping Face' },
	{ emoji: 'ðŸ˜·', name: 'Face with Medical Mask' },
	{ emoji: 'ðŸ¤’', name: 'Face with Thermometer' },
	{ emoji: 'ðŸ¤•', name: 'Face with Head-Bandage' },
	{ emoji: 'ðŸ¤¢', name: 'Nauseated Face' },
	{ emoji: 'ðŸ¤®', name: 'Face Vomiting' },
	{ emoji: 'ðŸ¤§', name: 'Sneezing Face' },
	{ emoji: 'ðŸ¥µ', name: 'Hot Face' },
	{ emoji: 'ðŸ¥¶', name: 'Cold Face' },
	{ emoji: 'ðŸ¥´', name: 'Woozy Face' },
	{ emoji: 'ðŸ˜µâ€ðŸ’«', name: 'Face with Spiral Eyes' },
	{ emoji: 'ðŸ¤¯', name: 'Exploding Head' },
	{ emoji: 'ðŸ¤ ', name: 'Cowboy Hat Face' },
	{ emoji: 'ðŸ¥³', name: 'Partying Face' },
	{ emoji: 'ðŸ¥¸', name: 'Disguised Face' },
	{ emoji: 'ðŸ˜Ž', name: 'Smiling Face with Sunglasses' },
	{ emoji: 'ðŸ¤“', name: 'Nerd Face' },
	{ emoji: 'ðŸ§', name: 'Face with Monocle' },
	{ emoji: 'ðŸ˜•', name: 'Confused Face' },
	{ emoji: 'ðŸ«¤', name: 'Face with Diagonal Mouth' },
	{ emoji: 'â˜¹', name: 'Frowning Face' },
	{ emoji: 'ðŸ˜²', name: 'Astonished Face' },
	{ emoji: 'ðŸ˜³', name: 'Flushed Face' },
	{ emoji: 'ðŸ¥º', name: 'Pleading Face' },
	{ emoji: 'ðŸ¥¹', name: 'Face Holding Back Tears' },
	{ emoji: 'ðŸ˜¨', name: 'Fearful Face' },
	{ emoji: 'ðŸ˜°', name: 'Anxious Face with Sweat' },
	{ emoji: 'ðŸ˜¢', name: 'Crying Face' },
	{ emoji: 'ðŸ˜­', name: 'Loudly Crying Face' },
	{ emoji: 'ðŸ˜±', name: 'Face Screaming in Fear' },
	{ emoji: 'ðŸ˜©', name: 'Weary Face' },
	{ emoji: 'ðŸ¥±', name: 'Yawning Face' },
	{ emoji: 'ðŸ˜¤', name: 'Face with Steam From Nose' },
	{ emoji: 'ðŸ˜¡', name: 'Enraged Face' },
	{ emoji: 'ðŸ¤¬', name: 'Face with Symbols on Mouth' },
	{ emoji: 'ðŸ˜ˆ', name: 'Smiling Face with Horns' },
	{ emoji: 'ðŸ‘¿', name: 'Angry Face with Horns' },
	{ emoji: 'ðŸ’€', name: 'Skull' },
	{ emoji: 'â˜ ', name: 'Skull and Crossbones' },
	{ emoji: 'ðŸ’©', name: 'Pile of Poo' },
	{ emoji: 'ðŸ¤¡', name: 'Clown Face' },
	{ emoji: 'ðŸ‘¹', name: 'Ogre' },
	{ emoji: 'ðŸ‘º', name: 'Goblin' },
	{ emoji: 'ðŸ‘»', name: 'Ghost' },
	{ emoji: 'ðŸ‘½', name: 'Alien' },
	{ emoji: 'ðŸ‘¾', name: 'Alien Monster' },
	{ emoji: 'ðŸ¤–', name: 'Robot' },
	{ emoji: 'ðŸ‘‹', name: 'Waving Hand' },
	{ emoji: 'ðŸ¤š', name: 'Raised Back of Hand' },
	{ emoji: 'ðŸ–', name: 'Hand with Fingers Splayed' },
	{ emoji: 'âœ‹', name: 'Raised Hand' },
	{ emoji: 'ðŸ––', name: 'Vulcan Salute' },
	{ emoji: 'ðŸ«±', name: 'Rightwards Hand' },
	{ emoji: 'ðŸ«²', name: 'Leftwards Hand' },
	{ emoji: 'ðŸ«³', name: 'Palm Down Hand' },
	{ emoji: 'ðŸ«´', name: 'Palm Up Hand' },
	{ emoji: 'ðŸ‘Œ', name: 'OK Hand' },
	{ emoji: 'ðŸ¤Œ', name: 'Pinched Fingers' },
	{ emoji: 'ðŸ¤', name: 'Pinching Hand' },
	{ emoji: 'âœŒ', name: 'Victory Hand' },
	{ emoji: 'ðŸ¤ž', name: 'Crossed Fingers' },
	{ emoji: 'ðŸ«°', name: 'Hand with Index Finger and Thumb Crossed' },
	{ emoji: 'ðŸ¤Ÿ', name: 'Love-You Gesture' },
	{ emoji: 'ðŸ¤˜', name: 'Sign of the Horns' },
	{ emoji: 'ðŸ¤™', name: 'Call Me Hand' },
	{ emoji: 'ðŸ‘ˆ', name: 'Backhand Index Pointing Left' },
	{ emoji: 'ðŸ‘‰', name: 'Backhand Index Pointing Right' },
	{ emoji: 'ðŸ‘†', name: 'Backhand Index Pointing Up' },
	{ emoji: 'ðŸ–•', name: 'Middle Finger' },
	{ emoji: 'ðŸ‘‡', name: 'Backhand Index Pointing Down' },
	{ emoji: 'â˜', name: 'Index Pointing Up' },
	{ emoji: 'ðŸ«µ', name: 'Index Pointing at the Viewer' },
	{ emoji: 'ðŸ‘', name: 'Thumbs Up' },
	{ emoji: 'ðŸ‘Ž', name: 'Thumbs Down' },
	{ emoji: 'âœŠ', name: 'Raised Fist' },
	{ emoji: 'ðŸ‘Š', name: 'Oncoming Fist' },
	{ emoji: 'ðŸ¤›', name: 'Left-Facing Fist' },
	{ emoji: 'ðŸ¤œ', name: 'Right-Facing Fist' },
	{ emoji: 'ðŸ‘', name: 'Clapping Hands' },
	{ emoji: 'ðŸ™Œ', name: 'Raising Hands' },
	{ emoji: 'ðŸ«¶', name: 'Heart Hands' },
	{ emoji: 'ðŸ‘', name: 'Open Hands' },
	{ emoji: 'ðŸ¤²', name: 'Palms Up Together' },
	{ emoji: 'ðŸ¤', name: 'Handshake' },
	{ emoji: 'ðŸ™', name: 'Folded Hands' },
	{ emoji: 'âœ', name: 'Writing Hand' },
	{ emoji: 'ðŸ’…', name: 'Nail Polish' },
	{ emoji: 'ðŸ¤³', name: 'Selfie' },
	{ emoji: 'ðŸ’ª', name: 'Flexed Biceps' },
	{ emoji: 'ðŸ¦¾', name: 'Mechanical Arm' },
	{ emoji: 'ðŸ¦µ', name: 'Leg' },
	{ emoji: 'ðŸ¦¿', name: 'Mechanical Leg' },
	{ emoji: 'ðŸ¦¶', name: 'Foot' },
	{ emoji: 'ðŸ‘‚', name: 'Ear' },
	{ emoji: 'ðŸ¦»', name: 'Ear with Hearing Aid' },
	{ emoji: 'ðŸ‘ƒ', name: 'Nose' },
	{ emoji: 'ðŸ§ ', name: 'Brain' },
	{ emoji: 'ðŸ«€', name: 'Anatomical Heart' },
	{ emoji: 'ðŸ«', name: 'Lungs' },
	{ emoji: 'ðŸ¦·', name: 'Tooth' },
	{ emoji: 'ðŸ¦´', name: 'Bone' },
	{ emoji: 'ðŸ‘€', name: 'Eyes' },
	{ emoji: 'ðŸ‘', name: 'Eye' },
	{ emoji: 'ðŸ‘…', name: 'Tongue' },
	{ emoji: 'ðŸ‘„', name: 'Mouth' },
	{ emoji: 'ðŸ«¦', name: 'Biting Lip' },
	{ emoji: 'â™ˆ', name: 'Aries' },
	{ emoji: 'â™‰', name: 'Taurus' },
	{ emoji: 'â™Š', name: 'Gemini' },
	{ emoji: 'â™‹', name: 'Cancer' },
	{ emoji: 'â™Œ', name: 'Leo' },
	{ emoji: 'â™', name: 'Virgo' },
	{ emoji: 'â™Ž', name: 'Libra' },
	{ emoji: 'â™', name: 'Scorpio' },
	{ emoji: 'â™', name: 'Sagittarius' },
	{ emoji: 'â™‘', name: 'Capricorn' },
	{ emoji: 'â™’', name: 'Aquarius' },
	{ emoji: 'â™“', name: 'Pisces' },
	{ emoji: 'â›Ž', name: 'Ophiuchus' }
];

export function generateEmojiId(eventId: ID): { emoji: string; name: string } {
	const existing = new Set(
		Array.from(db.participants.values()).filter(p => p.eventId === eventId).map(p => p.emojiId)
	);
	const available = EMOJIS.filter(e => !existing.has(e.emoji));
	if (available.length === 0) {
		throw new Error('No more unique emojis available');
	}
	const selected = available[Math.floor(Math.random() * available.length)];
	return selected;
}

export function joinEvent(eventId: ID, code: string, displayName?: string) {
	const event = db.events.get(eventId);
	if (!event) throw new Error('Event not found');
	if (event.code !== code) throw new Error('Invalid code');
	const emojiData = generateEmojiId(eventId);
	const id = randomId('usr_');
	const token = randomToken();
	const participant: Participant = { id, eventId, emojiId: emojiData.emoji, emojiName: emojiData.name, displayName, token, createdAt: now() };
	db.participants.set(id, participant);
	const presence: Presence = { participantId: id, eventId, connected: false, lastSeenAt: 0 };
	db.presence.set(id, presence);
	return { participant, token };
}

export function getEventSummary(eventId: ID): EventSummary | undefined {
	const event = db.events.get(eventId);
	if (!event) return undefined;
	const rounds = db.eventRounds.get(eventId) ?? [];
	const round = rounds.length ? db.rounds.get(rounds[rounds.length - 1]) : undefined;
	const participants = Array.from(db.participants.values()).filter(p => p.eventId === eventId);
	const list = participants.map(p => ({
		...p,
		presence: db.presence.get(p.id)
	}));
	const connectedCount = list.filter(p => p.presence?.connected).length;
	return { event, participants: list, round, connectedCount };
}

export function upsertPresence(participantId: ID, connected: boolean, clientInfo?: Record<string, unknown>) {
	const presence = db.presence.get(participantId);
	if (!presence) return;
	presence.connected = connected;
	presence.lastSeenAt = now();
	if (clientInfo) presence.clientInfo = clientInfo;
}

export function createRound(eventId: ID, index: number, roundSeed: number): Round {
	const id = randomId('rnd_');
	const round: Round = { id, eventId, index, createdAt: now(), roundSeed };
	db.rounds.set(id, round);
	const arr = db.eventRounds.get(eventId) ?? [];
	arr.push(id);
	db.eventRounds.set(eventId, arr);
	return round;
}

export function setAvoidance(eventId: ID, p1Id: ID, p2Id: ID, roundIndex: number) {
	const [a, b] = [p1Id, p2Id].sort();
	const key = `${eventId}:${a}:${b}`;
	db.avoidance.set(key, { eventId, p1Id: a, p2Id: b, lastPairedRoundIndex: roundIndex });
}

export function getAvoidance(eventId: ID, p1Id: ID, p2Id: ID): number {
	const [a, b] = [p1Id, p2Id].sort();
	const key = `${eventId}:${a}:${b}`;
	return db.avoidance.get(key)?.lastPairedRoundIndex ?? -1_000_000;
}

export function savePairings(roundId: ID, pairs: Array<Omit<Pairing, 'id'>>): Pairing[] {
	const ids: ID[] = [];
	const list: Pairing[] = [];
	for (const p of pairs) {
		const id = randomId('pr_');
		const row: Pairing = { id, ...p } as Pairing;
		db.pairings.set(id, row);
		ids.push(id);
		list.push(row);
	}
	db.roundPairs.set(roundId, ids);
	return list;
}

export function getConnectedParticipants(eventId: ID): Participant[] {
	return Array.from(db.participants.values()).filter(p => p.eventId === eventId && (db.presence.get(p.id)?.connected ?? false));
}

export function getRoundIndex(eventId: ID): number {
	const rounds = db.eventRounds.get(eventId) ?? [];
	return rounds.length;
}
